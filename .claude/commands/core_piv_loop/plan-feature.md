---
description: 从需求澄清到实施计划的完整流程
---

# 功能规划

## 功能: $ARGUMENTS

## 前置检查

**如果这是新会话或尚未加载项目上下文**，请先运行：
```
/core_piv_loop:prime
```
加载项目结构和关键文件后再继续。

---

## 使命

将用户的功能想法转化为**明确的需求文档和全面的实施计划**，通过需求澄清、PRD更新、代码库分析和战略规划。

**核心原则**：
1. 先明确需求，再制定计划
2. 需求必须写入PRD，成为唯一真实来源
3. 此阶段不写代码，目标是创建上下文丰富的计划

**关键理念**：文档驱动开发。PRD是连接需求和实施的桥梁。

## 完整流程

### 阶段0：读取现有PRD

**必须先执行**：
```
Read .claude/PRD.md
```
理解现有功能范围、技术栈、设计原则。

### 阶段1：需求澄清（与用户交互）

**目标**：理解用户真正想要什么

**步骤**：
1. 提取核心问题和用户价值
2. 确定类型：新功能/增强/重构/修复
3. 评估复杂度：低/中/高
4. 识别受影响的系统组件

**如果需求不清晰，使用 AskUserQuestion 工具询问**：
- 功能的具体行为是什么？
- 有哪些边界情况需要考虑？
- UI/UX 的期望是什么？
- 性能或安全要求？

**起草用户故事**：
```
作为 <用户类型>
我想 <操作/目标>
以便 <收益/价值>

验收标准：
- [ ] 标准1
- [ ] 标准2
```

### 阶段2：需求确认

**展示给用户**：
- 功能描述
- 用户故事
- 验收标准
- 受影响的系统

**使用 AskUserQuestion 确认**：
"我理解的需求如上所述，是否正确？是否需要调整？"

### 阶段3：更新PRD

**确认后立即执行**：

1. **读取PRD**：`Read .claude/PRD.md`（如果阶段0未读取）

2. **更新相应章节**：
   - 如果是新功能：添加到"用户故事"章节
   - 如果是增强：更新现有功能描述
   - 如果影响MVP范围：更新"MVP范围"章节

3. **使用Edit工具更新文件**

4. **确认更新**：告知用户"PRD已更新，需求已记录"

### 阶段4：代码库情报收集

**1. 项目结构分析**
- 检测语言、框架、版本
- 映射目录结构和架构模式
- 定位配置文件

**2. 模式识别**
- 搜索类似实现
- 识别命名约定、错误处理、日志模式
- 检查 CLAUDE.md 项目规则

**3. 依赖分析**
- 编目相关外部库
- 查找 docs/ 或 reference/ 中的文档

**4. 测试模式**
- 识别测试框架和结构
- 找到类似测试示例

**5. 集成点**
- 识别需更新的现有文件
- 确定需创建的新文件
- 映射路由/API 注册模式

**澄清歧义**：需求不清时先询问用户

### 阶段5：外部研究

- 研究最新库版本和最佳实践
- 查找官方文档
- 识别常见陷阱

### 阶段6：深度战略思考

- 如何融入现有架构？
- 关键依赖和操作顺序？
- 可能出错的地方？
- 如何全面测试？
- 性能和安全考虑？

### 阶段7：生成实施计划

输出到：`.agents/plans/{kebab-case-名称}.md`

## 计划模板

```markdown
# 功能: <功能名>

## 功能描述
<详细描述>

## 用户故事
作为...我想...以便...

## 功能元数据
- **类型**: [新功能/增强/重构/修复]
- **复杂度**: [低/中/高]
- **受影响系统**: [组件列表]

---

## 上下文引用

### 必读代码文件
- `path/to/file.py` (行 15-45) - 原因

### 要创建的新文件
- `path/to/new.py` - 用途

### 必读文档
- [文档链接](url) - 原因

### 要遵循的模式
<从代码库提取的具体模式>

---

## 实现计划

### 阶段1：基础
### 阶段2：核心实现
### 阶段3：集成
### 阶段4：测试验证

---

## 逐步任务

### {操作} {目标文件}
- **实现**: {具体细节}
- **模式**: {参考 - 文件:行}
- **验证**: `{可执行命令}`

---

## 测试策略
### 单元测试
### 集成测试

---

## 验证命令
### 级别1：语法检查
### 级别2：单元测试
### 级别3：集成测试
### 级别4：手动验证

---

## 验收标准
- [ ] 功能实现完整
- [ ] 所有验证通过
- [ ] 测试覆盖 80%+
- [ ] 遵循项目约定
```

## 质量标准

- [ ] 所有必要模式已识别
- [ ] 每个任务有可执行验证命令
- [ ] 任务按依赖排序
- [ ] 模式引用包含文件:行号

## 报告

创建计划后提供：
- 功能和方法摘要
- 计划文件完整路径
- 复杂度评估
- 一次成功的置信度评分
